<!DOCTYPE html>
<html><head><title>VVOX</title>
<script src="https://cdn.jsdelivr.net/npm/webmidi"></script>
<script>
navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;
window.app={invert:false,wb:false,wf:'sine',tuned:4186.01,fps:5,cutoff:75};
app.bodyload=function(){app.loadcams();
WebMidi.enable(function(err){if(err){console.log("WebMidi could not be enabled.", err);}else {console.log("WebMidi enabled!");
	var o=0;var ssoo=document.getElementById('sel_outputs');
		if(WebMidi.outputs.length>0){
		for(o=0;o<WebMidi.outputs.length;o++){
			var oelm=document.createElement('option');
			oelm.value=WebMidi.outputs[o].id;
			oelm.innerHTML=WebMidi.outputs[o].name;
			ssoo.appendChild(oelm);
		}}else{alert('no midi channel detected - we suggest to use loopmidi for virtual midi ports.')}}});
};
app.mapcc=function(ch,cc){WebMidi.outputs[document.getElementById('sel_outputs').selectedIndex].sendControlChange(cc,50,ch);};
app.mapnote=function(ch){WebMidi.outputs[document.getElementById('sel_outputs').selectedIndex].playNote(75,ch,{duration:500});};
app.init=function(){
	var e=document.getElementById('starters');e.style.display='none';
	document.getElementById('resetB').classList.remove('hidden');
	app.SSO=WebMidi.outputs[document.getElementById('sel_outputs').selectedIndex];
	app.video=document.querySelector('video');app.canvas1=document.querySelector('#canvas1');app.context1=app.canvas1.getContext('2d');
	app.canvas2=document.querySelector('#canvas2');app.context2=app.canvas2.getContext('2d');
	app.tune(app.tuned);};
app.tune=function(v,b){if(b){document.querySelector('.btuned').classList.remove('btuned');b.classList.add('btuned');}if(app.invert){app.tuneINV(v)}else{app.tuneSTR(v)}}
app.tuneSTR=function(v){app.tuned=v;app.FRQ=[];app.FRQ[5]=v;app.FRQ[4]=app.FRQ[5]/2;app.FRQ[6]=app.FRQ[4];app.FRQ[3]=app.FRQ[4]/2;app.FRQ[7]=app.FRQ[3];app.FRQ[2]=app.FRQ[3]/2;app.FRQ[8]=app.FRQ[2];app.FRQ[1]=app.FRQ[2]/2;app.FRQ[9]=app.FRQ[1];app.FRQ[0]=app.FRQ[1]/2;app.FRQ[10]=app.FRQ[0];};
app.tuneINV=function(v){app.tuned=v;app.FRQ=[];app.FRQ[0]=v;app.FRQ[10]=app.FRQ[0];
app.FRQ[1]=app.FRQ[0]/2;app.FRQ[9]=app.FRQ[1];
app.FRQ[2]=app.FRQ[1]/2;app.FRQ[8]=app.FRQ[2];
app.FRQ[3]=app.FRQ[2]/2;app.FRQ[7]=app.FRQ[3];
app.FRQ[4]=app.FRQ[3]/2;app.FRQ[6]=app.FRQ[4];
app.FRQ[5]=app.FRQ[4]/2;};
app.start=function(videoSource,num,elm){app.init();var constraints={audio:false,video:{facingMode:'user'}};
	//if(num=='2'){constraints.video.facingMode='environment';}
	if(elm.innerHTML.toLowerCase().indexOf('back')>-1){constraints.video.facingMode='environment';}
	else if(num=='2'){constraints.video.facingMode='environment';}
	//constraints.video.facingMode='environment';
	navigator.mediaDevices.getUserMedia(constraints).then(
	function(stream){app.video.srcObject=stream;app.video.onloadedmetadata=function(e){app.video.play();};}).catch(
	function(err){console.log(err.name + ": " + err.message);});setTimeout(app.startplay,50);};
app.startv=function(v){app.init();var s=document.createElement('source');video.pause();s.setAttribute('src', v);video.appendChild(s);video.load();video.volume=0;video.play();setTimeout(app.startplay,1000);};
app.startplay=function(){var e=document.getElementById('starters');e.style.display='none';e.parentElement.removeChild(e.nextSibling);app.cycle=setInterval(app.frame,1000/app.fps);};
app.lastoutBRIGHTEST=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
app.lastoutDARKEST=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
app.noteONGRID=[
	['C0',	'A#0',	'G#0',	'F#0',	'F0',	'D#0',	'C#0',	'D#0',	'F0',	'F#0',	'G#0',	'A#0',	'C0'],
	['D1',	'C1',	'A#1',	'G#1',	'G1',	'F1',	'D#1',	'F1',	'G1',	'G#1',	'A#1',	'C1',	'D1'],
	['E2',	'D2',	'C2',	'A#2',	'A2',	'F2',	'G2',	'F2',	'A2',	'A#2',	'C2',	'D2',	'E2'],
	['F#3',	'E3',	'D3',	'C3',	'B3',	'A3',	'G3',	'A3',	'B3',	'C3',	'D3',	'E3',	'F#3'],
	['G4',	'F4',	'D#4',	'C#4',	'C4',	'A#4',	'G#4',	'A#4',	'C4',	'C#4',	'D#4',	'F4',	'G4'],
	['A5',	'G5',	'F5',	'D#5',	'D5',	'C5',	'A#5',	'C5',	'D5',	'D#5',	'F5',	'G5',	'A5'],	
	['B6',	'A6',	'G6',	'F6',	'E6',	'D6',	'C6',	'D6',	'E6',	'F6',	'G6',	'A6',	'B6'],
	['A5',	'G5',	'F5',	'D#5',	'D5',	'C5',	'A#5',	'C5',	'D5',	'D#5',	'F5',	'G5',	'A5'],
	['G4',	'F4',	'D#4',	'C#4',	'C4',	'A#4',	'G#4',	'A#4',	'C4',	'C#4',	'D#4',	'F4',	'G4'],
	['F#3',	'E3',	'D3',	'C3',	'B3',	'A3',	'G3',	'A3',	'B3',	'C3',	'D3',	'E3',	'F#3'],
	['E2',	'D2',	'C2',	'A#2',	'A2',	'F2',	'G2',	'F2',	'A2',	'A#2',	'C2',	'D2',	'E2'],
	['D1',	'C1',	'A#1',	'G#1',	'G1',	'F1',	'D#1',	'F1',	'G1',	'G#1',	'A#1',	'C1',	'D1'],
	['C0',	'A#0',	'G#0',	'F#0',	'F0',	'D#0',	'C#0',	'D#0',	'F0',	'F#0',	'G#0',	'A#0',	'C0']
];

app.frame=function(){app.context1.drawImage(video, 0, 0, 128, 18);app.context2.drawImage(video, 0, 0, 13, 13);
    var dd1 = new Uint8Array(app.context1.getImageData(0, 0,128,18).data.buffer);
    var dd2 = new Uint8Array(app.context2.getImageData(0, 0,13,13).data.buffer);
	var tmp;var maxavg=0;var minavg=0;var c=0;var r=0;var rx;var cx;
	var maxavgx=0;var minavgx=255;
	for(r=0;r<18;r++){rx=r*128*4;maxavg=0;minavg=255;
		for(c=0;c<128;c++){cx=rx+(c*4);tmp=(dd1[cx]+dd1[cx+1]+dd1[cx+2])/3;if(tmp>maxavg){maxavg=tmp;maxavgx=c};if(tmp<minavg){minavg=tmp;minavgx=c};}
		//Brightest x line - START
		tmp=Math.floor(Math.abs(maxavgx));
		if(tmp!=app.lastoutBRIGHTEST[r]){app.lastoutBRIGHTEST[r]=tmp;app.SSO.sendControlChange(r+102,tmp,1);}
		//Darkest x line - START
		tmp=Math.floor(Math.abs(minavgx));
		if(tmp!=app.lastoutDARKEST[r]){app.lastoutDARKEST[r]=tmp;app.SSO.sendControlChange(r+102,tmp,1);}
	}
	var brightest=0;var brightestx=0;var brightesty=0;
	var darkest=255;var darkestx=0;var darkesty=0;
	var ctemp=[];
	var R_est=1000;var R_x=0;var R_y=0;var R_tmp;
	var G_est=1000;var G_x=0;var G_y=0;var G_tmp;
	var B_est=1000;var B_x=0;var B_y=0;var B_tmp;
	for(r=0;r<13;r++){rx=r*13*4;maxavg=0;minavg=255;
		for(c=0;c<13;c++){cx=rx+(c*4);tmp=(dd2[cx]+dd2[cx+1]+dd2[cx+2])/3;if(tmp>maxavg){maxavg=tmp;maxavgx=c};if(tmp<minavg){minavg=tmp;minavgx=c};
			ctemp=[dd2[cx],dd2[cx+1],dd2[cx+2]];
			R_tmp=deltaE(app.RR,ctemp);if(R_tmp<R_est){R_est=R_tmp;R_x=c;R_y=r}
			G_tmp=deltaE(app.GG,ctemp);if(G_tmp<G_est){G_est=G_tmp;G_x=c;G_y=r}
			B_tmp=deltaE(app.BB,ctemp);if(B_tmp<B_est){B_est=B_tmp;B_x=c;B_y=r}
		}
		if(maxavg>brightest){brightest=maxavg;brightestx=maxavgx;brightesty=(r);}if(minavg<darkest){darkest=minavg;darkestx=minavgx;darkesty=r}
	}
	if(brightest>64){app.SSO.playNote(app.noteONGRID[brightesty][brightestx],3,{duration:500});}
	if(darkest<194){app.SSO.playNote(app.noteONGRID[darkesty][darkestx],4,{duration:500});}
	if(R_est<40){app.SSO.playNote(app.noteONGRID[R_y][R_x],5,{duration:500});}
	if(G_est<40){app.SSO.playNote(app.noteONGRID[G_y][G_x],6,{duration:500});}
	if(B_est<40){app.SSO.playNote(app.noteONGRID[B_y][B_x],7,{duration:500});}
};
app.setfps=function(fps){app.fps=fps;if(app.cycle){clearInterval(app.cycle);app.cycle=setInterval(app.frame,1000/fps);}};

app.setall=function(wf,fps,ramp,cutoff,invert,url){app.fps=fps;e=document.getElementById('fps');e.innerHTML=fps;
	app.invert=invert;var e=document.getElementById('binvert');if(app.invert){e.classList.add('toggled')}else{e.classList.remove('toggled')}
	app.cutoff=cutoff;e=document.getElementById('cutoff');e.innerHTML=cutoff;
	app.wf=wf;e=document.getElementById('bwf');app.wf=wf;
	if(url){app.startv(url);};document.getElementById('panel').style.display='';}


app.gotDevices=function(deviceInfos){var starters=document.getElementById('starters');var x=0;for(var i = 0; i < deviceInfos.length; ++i) {
   if (deviceInfos[i].kind === 'videoinput') {var butt=document.createElement('button');x=x+1;
	butt.setAttribute('value',x+'^'+deviceInfos[i].deviceId);butt.setAttribute('onclick','app.cambutton(this)');
	butt.innerHTML=deviceInfos[i].label || 'camera ' + x;
    starters.insertBefore(butt,document.getElementById('firstVideo'));}
}};app.handleError=function(error){console.log('navigator.getUserMedia error: ', error);};
app.loadcams=function(){navigator.mediaDevices.enumerateDevices().then(app.gotDevices).catch(app.handleError);};
app.cambutton=function(elm){if(location.protocol!='https:'){alert('...haaa security, you must use https to use camera!');}else{
	var v=elm.value.split('^');app.setall('sine',5,false,180)}app.start(v[1],v[0],elm);};


function deltaE(labA, rgbB) {
  let labB = rgb2lab(rgbB);
  let deltaL = labA[0] - labB[0];
  let deltaA = labA[1] - labB[1];
  let deltaB = labA[2] - labB[2];
  let c1 = Math.sqrt(labA[1] * labA[1] + labA[2] * labA[2]);
  let c2 = Math.sqrt(labB[1] * labB[1] + labB[2] * labB[2]);
  let deltaC = c1 - c2;
  let deltaH = deltaA * deltaA + deltaB * deltaB - deltaC * deltaC;
  deltaH = deltaH < 0 ? 0 : Math.sqrt(deltaH);
  let sc = 1.0 + 0.045 * c1;
  let sh = 1.0 + 0.015 * c1;
  let deltaLKlsl = deltaL / (1.0);
  let deltaCkcsc = deltaC / (sc);
  let deltaHkhsh = deltaH / (sh);
  let i = deltaLKlsl * deltaLKlsl + deltaCkcsc * deltaCkcsc + deltaHkhsh * deltaHkhsh;
  return i < 0 ? 0 : Math.sqrt(i);
}
function rgb2lab(rgb){
  let r = rgb[0] / 255, g = rgb[1] / 255, b = rgb[2] / 255, x, y, z;
  r = (r > 0.04045) ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
  g = (g > 0.04045) ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
  b = (b > 0.04045) ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;
  x = (r * 0.4124 + g * 0.3576 + b * 0.1805) / 0.95047;
  y = (r * 0.2126 + g * 0.7152 + b * 0.0722) / 1.00000;
  z = (r * 0.0193 + g * 0.1192 + b * 0.9505) / 1.08883;
  x = (x > 0.008856) ? Math.pow(x, 1/3) : (7.787 * x) + 16/116;
  y = (y > 0.008856) ? Math.pow(y, 1/3) : (7.787 * y) + 16/116;
  z = (z > 0.008856) ? Math.pow(z, 1/3) : (7.787 * z) + 16/116;
  return [(116 * y) - 16, 500 * (x - y), 200 * (y - z)]
};
app.RR=rgb2lab([255,0,0]);app.GG=rgb2lab([0,255,0]);app.BB=rgb2lab([0,0,255]);
</script><style>html{width:100%;}body{background-color:black;color:#dddddd;width:100%;margin:0;padding:0;text-align:center;font:arial}
span{padding:2px;margin-top:1px}
button,input,select,span{font-size:24px;color:#dddddd;background-color:#444444;border-style:outset;}
.toggled{background-color:#D00}.btuned{background-color:#D00}
.hidden{display:none !important}
#chart_img{width:80%;margin-left:10%}
td{height:2px;width:2px;border:1px solid grey}</style></head><body onload="app.bodyload()">
<button onclick="document.location.reload()" style="position:absolute;z-index:2;top:20px;width:33%;left:33%" class="a b hidden" id="resetB">RESET</button>
<div style="width:100%;text-align:center;position:absolute;z-index:1">
<div id="starters" style="display:inline-block;margin-top:5%">
	MIDI OUT:<select id="sel_outputs"></select> <button onclick="document.getElementById('mapper_div').classList.toggle('hidden');document.getElementById('chartButt').classList.toggle('hidden')">TOGGLE MAPPER</button> <button id="chartButt" class="a b hidden" onclick="document.getElementById('chart_img').classList.toggle('hidden')">VIEW NOTEON-CHART</button><br/>
<button id="firstVideo" onclick="app.setall('sine',8,true,100,false,'moviex.mov');">VIDEO1</button>
<button onclick="app.setall('triangle',8,false,80,true,'a.mp4');">VIDEO2</button>
<button onclick="app.setall('sawtooth',8,false,135,false,'b.mp4');">VIDEO3</button>
<button onclick="app.setall('square',8,true,50,false,'d.mp4');">VIDEO4</button>
<button onclick="app.setall('square',8,true,50,false,'2019A.mp4');">VIDEO 2019A</button>
<button onclick="app.setall('square',8,true,50,false,'2019B.mp4');">VIDEO 2019B</button>
	<div id="mapper_div" style="text-align:left;width:90%;margin-left:5%;inline-block;" class="a b hidden">
		The following are control change messages, the video is read in 18 lines and 128 columns[0-127 from left to right]:<ul>
		  <li>Brightest per line(channel 1, cc102-119)<br/>
<button onclick="app.mapcc(1,1)">C1-102</button><button onclick="app.mapcc(1,2)">C1-103</button><button onclick="app.mapcc(1,3)">C1-104</button><button
 onclick="app.mapcc(1,4)">C1-105</button><button onclick="app.mapcc(1,5)">C1-106</button><button onclick="app.mapcc(1,6)">C1-107</button><button
 onclick="app.mapcc(1,7)">C1-108</button><button onclick="app.mapcc(1,8)">C1-109</button><button onclick="app.mapcc(1,9)">C1-110</button><button
 onclick="app.mapcc(1,10)">C1-111</button><button onclick="app.mapcc(1,11)">C1-112</button><button onclick="app.mapcc(1,12)">C1-113</button><button
 onclick="app.mapcc(1,13)">C1-114</button><button onclick="app.mapcc(1,14)">C1-115</button><button onclick="app.mapcc(1,15)">C1-116</button><button
 onclick="app.mapcc(1,16)">C1-117</button><button onclick="app.mapcc(1,17)">C1-118</button><button onclick="app.mapcc(1,18)">C1-119</button>
		  </li><li>Darkest per line(channel 2, cc102-119)<br/>
<button onclick="app.mapcc(2,1)">C2-102</button><button onclick="app.mapcc(2,2)">C2-103</button><button onclick="app.mapcc(2,3)">C2-104</button><button
 onclick="app.mapcc(2,4)">C2-105</button><button onclick="app.mapcc(2,5)">C2-106</button><button onclick="app.mapcc(2,6)">C2-107</button><button
 onclick="app.mapcc(2,7)">C2-108</button><button onclick="app.mapcc(2,8)">C2-109</button><button onclick="app.mapcc(2,9)">C2-110</button><button
 onclick="app.mapcc(2,10)">C2-111</button><button onclick="app.mapcc(2,11)">C2-112</button><button onclick="app.mapcc(2,12)">C2-113</button><button
 onclick="app.mapcc(2,13)">C2-114</button><button onclick="app.mapcc(2,14)">C2-115</button><button onclick="app.mapcc(2,15)">C2-116</button><button
 onclick="app.mapcc(2,16)">C2-117</button><button onclick="app.mapcc(2,17)">C2-118</button><button onclick="app.mapcc(2,18)">C2-119</button>
		</li></ul><br/>
		The following are for note-on messages, the video is read in 13 x 13 columns the center being the highest[C6]:<br/><ul style="display:inline-block">
			<li>Brightest of all(channel 3, noteon) <button onclick="app.mapnote(3)">C3-NOTEON</button></li>
			<li>Darkest of all(channel 4, noteon) <button onclick="app.mapnote(4)">C4-NOTEON</button></li>
			<li>Reddested of all(channel 5, noteon) <button onclick="app.mapnote(5)">C5-NOTEON</button></li>
			<li>Greenest of all(channel 6, noteon) <button onclick="app.mapnote(6)">C6-NOTEON</button></li>
			<li>Most Blue of all(channel 7, noteon) <button onclick="app.mapnote(7)">C7-NOTEON</button></li></ul>
			<img id="chart_img" src="chart.png" class="a b hidden" />
	</div>
</div>
<div id="panel" style="display:none"><button onclick="var v=this.nextSibling;if(v.style.display=='none'){v.style.display=''}else{v.style.display='none'}" style="display:none">!@</button><div style="display:none">
<button onclick="app.invert=!app.invert;app.tune(app.tuned);this.classList.toggle('toggled')" id="binvert">H2L/L2H</button> <button onclick="app.wb=!app.wb;this.classList.toggle('toggled')">BW/WB</button><br/>
<button onclick="var e=document.getElementById('cutoff');var v=parseInt(e.innerHTML)+5;if(v>200){v=200};e.innerHTML=v;app.cutoff=v">LESS</button><span id="cutoff" class="toggled">10</span><button onclick="var e=document.getElementById('cutoff');var v=parseInt(e.innerHTML)-5;if(v<0){v=0};e.innerHTML=v;app.cutoff=v;">MORE</button><br/>
<button onclick="var e=document.getElementById('fps');var v=parseInt(e.innerHTML)-1;if(v<0){v=0};e.innerHTML=v;app.setfps(v)">SLOWER</button><span id="fps" class="toggled">5</span><button onclick="var e=document.getElementById('fps');var v=parseInt(e.innerHTML)+1;if(v>100){v=100};e.innerHTML=v;app.setfps(v);">FASTER</button><br/>
<button onclick="app.tune(4186,this);" class="btuned">C</button> <button onclick="app.tune(4434.913,this);">C#/Db</button> <button onclick="app.tune(4698.626,this);">D</button> <button onclick="app.tune(4978.021,this);">D#/Eb</button>
<button onclick="app.tune(5274.030,this);">E</button> <button onclick="app.tune(5587.640,this);">F</button> <button onclick="app.tune(5919.898,this);">F#/Gb</button> <button onclick="app.tune(6271.913,this);">G</button>
<button onclick="app.tune(6644.861,this);">G#Ab</button> <button onclick="app.tune(7039.985,this);">A</button> <button onclick="app.tune(7458.604,this);">A#/Bb</button> <button onclick="app.tune(7902.116,this);">B</button></div></div></div>
<video id="video" style="width:60%;position:absolute;z-index:0;top:55px;left:20%;"></video><br/><canvas
	id="canvas1" width="128" height="18" style="display:none"></canvas><canvas
	id="canvas2" width="13" height="13" style="display:none"></canvas>
</body></html>
